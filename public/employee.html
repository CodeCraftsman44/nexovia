<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Employee Dashboard</title>
  <link rel="stylesheet" href="/css/main.css">
  <style>
    /*
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      margin: 0;
      padding: 0;
    }
    */
    /*
    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      padding: 10px;
      padding-bottom: 80px;
      gap: 10px;
    }

    .position-left, .position-right {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      padding: 10px;
      margin: 0;
      flex: 1;
      min-width: 280px;
    }

    .position-left h1 {
      color: #333;
      margin-bottom: 20px;
      font-size: 30px;
    }
      */
      
form label {
  display: block;
  margin-bottom: 2px;
  font-weight: bold;
  font-size: 12px;
  text-align: left;
  width: 100%; 
  margin-left: auto;
  margin-right: auto;
  padding-left: 2px;
}

form input,
form textarea,
form select {
  width: 100%;           
  margin-left: auto;    
  margin-right: auto;
  padding: 6px;
  margin-bottom: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 14px;
  display: block;
}
/*
form button {
  width: 90px;
  min-width: unset;
  max-width: unset;
  font-size: 12px;
  padding: 4px 0;
  margin: 10px auto 0 auto;
  border-radius: 4px;
  display: block;
  background-color: #007caa; 
  color: #fff;
  border: none;
  transition: background 0.2s;
}

form button:hover {
  background-color: #007caa; 
}

    .position-right h2 {
      color: #007caa;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #department-name {
      font-size: 15px;
      color: #555;
      font-weight: normal;
    }
    .position-right {
  display: flex;
  flex-direction: column;
  height: 100%;
}
  */

    .table-container {
  flex: 1 1 auto;
  max-height: 550px;
  height: 100%;
  overflow-y: auto;
  overflow-x: hidden;
  border: 1px solid #ddd;
  border-radius: 4px;
  margin-top: 0;
}
.container-grid2, .container {
  padding-bottom: 45px; /* Adjust to match or exceed footer height */
}

    table {
  width: 100%;

  
  border-collapse: collapse;
  font-size: 14px;
  table-layout: auto;
}

    table th, table td {
      text-align: left;
      padding: 10px;
      border: 1px solid #ddd;
    }

    table th {
      background-color: #007caa;
      color: white;
      position: sticky;
      top: 0;
    }

    table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    table tbody tr:hover {
  background-color: #e6ecd6;
  cursor: pointer;
}
/*
    footer {
      background-color: #333;
      color: white;
      text-align: center;
      padding: 0;
      font-size: 8px;
      line-height: 1;
      position: fixed;
      bottom: 0;
      width: 100%;
      z-index: 10;
      height: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
      .position-left, .position-right {
        min-width: 100%;
      }
    }
    .position-left form {
      margin-bottom: 20px;
    }

    
    @media (max-height: 700px) {
      .position-left form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px 20px;
        align-items: start;
      }
      .position-left form label,
      .position-left form input,
      .position-left form textarea,
      .position-left form select {
        width: 100%;
      }
     
      .position-left form label {
        grid-column: span 2;
      }
      .position-left form input,
      .position-left form textarea,
      .position-left form select {
        grid-column: span 2;
      }
      
      .position-left form button {
        grid-column: span 2;
        justify-self: center;
      }
    }
      */
  </style>
</head>
<body>
  <!-- Navigation Panel -->
		<nav>
			<div class="company" id="employee-name"></div>
			<div>
				<a href=""><strong>Employee Dashboard</strong></a>
        <a href=""><strong>Example</strong></a>
        <a href=""><strong>Example</strong></a>
			</div>
			<div>
				<button onclick="logout()" style="background-color: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
      Logout
    </button>
			</div>
		</nav>

  <div class="container-grid2">
    <div class="position-left">
      <h2 style="text-align: center;">Create New Project</h2>
      <br>
      <br>
      <form onsubmit="event.preventDefault(); createProposal();">
        <label for="proposal-title">Title:</label>
        <input type="text" id="proposal-title" placeholder="Enter proposal title" required>
        <label for="proposal-description">Description:</label>
        <textarea id="proposal-description" placeholder="Enter proposal description" required></textarea>
        <label for="proposal-usage">Usage:</label>
        <input type="text" id="proposal-usage" placeholder="Describe the usage" required>
        <label for="proposal-strategic">Strategic Importance:</label>
        <input type="text" id="proposal-strategic" placeholder="Describe the strategic importance" required>
        <label for="proposal-duration">Estimated Duration (months):</label>
        <input type="number" id=  "proposal-duration" min="1" placeholder="e.g. 6" required>
        <label for="proposal-workload">Estimated Workload (person-days):</label>
        <input type="number" id="proposal-workload" min="1" placeholder="e.g. 30" required>
        <label for="proposal-cost">Estimated Cost:</label>
        <input type="number" id="proposal-cost" min="0" placeholder="e.g. 1000" required>
        <label for="proposal-benefit">Estimated Benefit:</label>
        <input type="number" id="proposal-benefit" min="0" placeholder="e.g. 2000" required>
        <label for="proposal-risk">Risk Assessment:</label>
        <input type="text" id="proposal-risk" placeholder="Describe the risk assessment" required>
        <br>
        <br>
        <button type="submit">Submit Proposal</button>
      </form>
    </div>
    <div class="position-right" style="padding-right: 10%;">
      <h2 style="text-align: center;" >
        Proposals <span id="department-name"></span>
      </h2>
      <br>
      <br>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Title</th>
              <th>Employee</th>
              <th>Priority</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="proposals-table-body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <p>-- DHBW Project by Supernova --</p>
  </div>

  <script>
    let proposals = [];
    let socket;
    let username;

    function initWebSocket(user, role) {
      username = user;
      socket = new WebSocket("ws://localhost:7777");

      socket.onopen = () => {
        socket.send(JSON.stringify({ type: "login", data: { username, role } }));
      };

      socket.onmessage = (event) => {
        const message = JSON.parse(event.data);

        if (message.type === "proposals") {
          proposals = message.data;
          renderTable(proposals);
        } else if (message.type === "newProposal") {
          proposals.push(message.data);
          renderTable(proposals);
        }
      };
    }

    function renderTable(proposals) {
      const tableBody = document.getElementById("proposals-table-body");
      tableBody.innerHTML = "";

      proposals.forEach((proposal) => {
        const priorityText = proposal.priority === "1" ? "High" : proposal.priority === "2" ? "Medium" : "Low";

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${proposal.title}</td>
          <td>${proposal.createdBy}</td>
          <td>${priorityText}</td>
          <td>${proposal.status}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    function createProposal() {
      const title = document.getElementById("proposal-title").value;
      const description = document.getElementById("proposal-description").value;
      // const priority = document.getElementById("proposal-priority").value;

      // Collect all new fields
      const usage = document.getElementById("proposal-usage").value;
      const strategic = document.getElementById("proposal-strategic").value;
      const duration = document.getElementById("proposal-duration").value;
      const workload = document.getElementById("proposal-workload").value;
      const cost = document.getElementById("proposal-cost").value;
      const benefit = document.getElementById("proposal-benefit").value;
      const risk = document.getElementById("proposal-risk").value;

      if (!title || !description || !usage || !strategic || !duration || !workload || !cost || !benefit || !risk) {
        alert("Please fill out all fields");
        return;
      }

      socket.send(
        JSON.stringify({
          type: "createProposal",
          data: {
            title,
            description,
            usage,
            strategicImportance: strategic,
            estimatedDuration: duration,
            estimatedWorkload: workload,
            estimatedCost: cost,
            estimatedBenefit: benefit,
            riskAssessment: risk,
            // priority,
            createdBy: username
          },
        })
      );

      document.getElementById("proposal-title").value = "";
      document.getElementById("proposal-description").value = "";
      document.getElementById("proposal-usage").value = "";
      document.getElementById("proposal-strategic").value = "";
      document.getElementById("proposal-duration").value = "";
      document.getElementById("proposal-workload").value = "";
      document.getElementById("proposal-cost").value = "";
      document.getElementById("proposal-benefit").value = "";
      document.getElementById("proposal-risk").value = "";
      // document.getElementById("proposal-priority").value = "1";
    }

    window.onload = async () => {
      try {
        const loggedInUsername = new URLSearchParams(window.location.search).get("username");
        if (!loggedInUsername) {
          throw new Error("Username is missing. Please log in again.");
        }

        const response = await fetch(`/api/user?username=${loggedInUsername}`);
        if (!response.ok) {
          throw new Error("Failed to fetch user information");
        }

        const userData = await response.json();
        initWebSocket(loggedInUsername, userData.role);

        // Set employee name in header
        document.getElementById("employee-name").textContent = userData.name || loggedInUsername;

        // Set department next to Proposals
        document.getElementById("department-name").textContent = userData.department ? `(${userData.department})` : "";
      } catch (error) {
        console.error("Error fetching user information:", error);
      }
    };

    function logout() {
      const username = new URLSearchParams(window.location.search).get("username");

      fetch("/logout", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ username })
      })
      .then(response => response.json())
      .then(data => {
        if (data.result === "success") {
          if (socket && socket.readyState === WebSocket.OPEN) {
            socket.close();
          }
          window.location.href = "/login.html";
        } else {
          alert("Logout failed: " + data.message);
        }
      })
      .catch((err) => {
        console.error("Logout error:", err);
        alert("An error occurred while logging out.");
      });
    }
  </script>
</body>
</html>